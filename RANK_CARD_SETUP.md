# Discord Rank Card System

This document describes the Discord Rank Card system implementation for displaying user stats in real-time.

## Overview

The rank card system provides a public-facing page that displays Discord member statistics (level, XP, rank) with real-time updates via Firestore `onSnapshot`.

## Architecture

### Components

1. **Client Page**: `/guilds/{guild_id}/rank-card/{user_discord_display_name}`
   - Decodes and normalizes unicode display names
   - Calls ensure endpoint to initialize rank card
   - Subscribes to Firestore for real-time updates
   - Renders appropriate UI based on status

2. **Server API**: `/api/guilds/{guild_id}/rank-card/ensure` (POST)
   - Uses Firebase Admin SDK (server-side only)
   - Queries members by normalized display name
   - Handles collision detection
   - Creates/updates rank card documents

3. **Firestore Collections**:
   - `guilds/{guildId}/members` - Member statistics
   - `guilds/{guildId}/rankCards/{cardId}` - Generated rank cards

## Environment Variables

### Required for Client (Public)

Add these to your `.env` file for client-side Firebase:

```bash
NEXT_PUBLIC_RANKCARD_FIREBASE_API_KEY='your_api_key'
NEXT_PUBLIC_RANKCARD_FIREBASE_AUTH_DOMAIN='your_auth_domain'
NEXT_PUBLIC_RANKCARD_FIREBASE_PROJECT_ID='your_project_id'
NEXT_PUBLIC_RANKCARD_FIREBASE_STORAGE_BUCKET='your_storage_bucket'
NEXT_PUBLIC_RANKCARD_FIREBASE_MESSAGING_SENDER_ID='your_sender_id'
NEXT_PUBLIC_RANKCARD_FIREBASE_APP_ID='your_app_id'
```

### Required for Server (Secret)

Add this to your `.env` file for Firebase Admin SDK:

```bash
FIREBASE_SERVICE_ACCOUNT_JSON='{"type":"service_account",...}'
```

**How to get service account JSON:**

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. Go to Project Settings > Service Accounts
4. Click "Generate new private key"
5. Copy the entire JSON content and paste it as a single-line string in the env var

**For Vercel deployment:**
- Add the service account JSON as an environment variable in your Vercel project settings
- Make sure to paste the entire JSON as a single line

## Firestore Data Structure

### Members Collection

Path: `guilds/{guildId}/members/{memberId}`

Required fields:
```typescript
{
  displayName: string;        // The user's Discord display name
  displayNameKey?: string;    // RECOMMENDED: Normalized lowercase key for search
  level: number;              // User's current level
  xp: number;                 // User's current XP
  rankName?: string;          // Optional rank title
  avatarUrl?: string;         // User's avatar URL
  avaterUrl?: string;         // Alternative spelling (typo support)
}
```

**Important**: We strongly recommend adding a `displayNameKey` field to your member documents for efficient and accurate lookups. This should be the normalized version of `displayName`:

```javascript
displayNameKey = displayName.trim().normalize('NFKC').toLowerCase()
```

### Rank Cards Collection

Path: `guilds/{guildId}/rankCards/{cardId}`

Generated by the ensure endpoint:
```typescript
{
  status: 'ready' | 'not_found' | 'ambiguous' | 'error';
  displayNameOriginal: string;
  displayNameKey: string;
  memberId?: string;
  level?: number;
  xp?: number;
  xpToNext?: number;
  rankName?: string;
  avatarUrl?: string;
  updatedAt: string;
  candidates?: Array<{
    memberId: string;
    displayName: string;
  }>;
}
```

The `cardId` is a stable hash generated from `guildId + ':' + displayNameKey`.

## Unicode Support

The system properly handles unicode display names through:

1. **URL Decoding**: `decodeURIComponent()`
2. **Trimming**: `.trim()`
3. **Normalization**: `.normalize('NFKC')`
4. **Case folding**: `.toLowerCase()`

This ensures that names like "ã‚ãšã‚Œ", "AzÃ¼rÃ©", or "ð“ð”ƒð“¾ð“»ð“®" are handled correctly.

## Status States

- **loading**: Initial state, shows shimmer loading screen
- **ready**: Member found, displays rank card
- **not_found**: No member with that display name
- **ambiguous**: Multiple members match (collision)
- **error**: System error occurred

## Real-Time Updates

The page uses Firestore's `onSnapshot` to listen for changes:

```typescript
onSnapshot(rankCardRef, (snapshot) => {
  // UI updates automatically when data changes
});
```

This means if a member's XP or level changes in Firestore, the rank card updates instantly without page refresh.

## XP Calculation

The system calculates XP to next level using a simple formula:

```typescript
xpToNext = (level + 1) * 100 - xp
```

You can customize this formula in `/api/guilds/[guild_id]/rank-card/ensure/route.ts`.

## UI Features

The rank card includes:
- Glass morphism design with gradient mesh background
- Subtle noise texture overlay
- Animated XP progress bar
- User avatar with fallback to initial letter
- Level badge
- Rank name display
- Responsive design

## Security Considerations

- Firebase Admin credentials are **never** exposed to the client
- Only server-side API routes use the Admin SDK
- Client uses public Firebase config with Firestore security rules
- Ensure your Firestore rules allow read access to `rankCards` collection

## Recommended Firestore Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow public read access to rank cards
    match /guilds/{guildId}/rankCards/{cardId} {
      allow read: if true;
      allow write: if false; // Only server can write
    }
    
    // Protect members collection
    match /guilds/{guildId}/members/{memberId} {
      allow read: if false;  // Only server can read
      allow write: if false; // Only server can write
    }
  }
}
```

## Troubleshooting

### "Member not found" error
- Check that the display name is spelled correctly
- Verify the member exists in `guilds/{guildId}/members`
- Ensure `displayNameKey` field is set correctly

### "Multiple members found" (ambiguous)
- This means multiple members have the same normalized display name
- Add unique identifiers or contact server admin to resolve

### Real-time updates not working
- Verify Firebase client config is correct
- Check browser console for Firestore errors
- Ensure Firestore rules allow read access

### Server errors
- Verify `FIREBASE_SERVICE_ACCOUNT_JSON` is set correctly
- Check server logs for detailed error messages
- Ensure the service account has proper permissions
